### 2-1 直播原理-HLS-1

1. 采集视频音频数据之后，是流的形式是原始的二进制数据，经过websock或者http 上传到服务器，接下来处理4个步骤
2. 
 1. 编码：原始的流数据是没办法让播放器播放的，需要用一定的协议去编码。直播常见的编码形式：视频编码H.264，音频编码ACC。直播流播出失败的时候最容易想到的排查点是他的编码是不是正确。
 2. 字幕叠加，水印等，有可能有也有可能没有。对视频本身的处理
 3. 推流：将处理好的视频推送到服务器上。
 4. 服务器再部署到CDN上。静态资源多媒体资源发布到CDN上保证用户体验和拉取的速度
3. PC 安卓 IOS回放

MP4兼容性好，都支持
YouTube：webm 但是Safari和IE不支持
hls：是一种视频协议。真正的视频是video.ts 只有Safari支持。苹果推出
flv：B站，早期flash格式。B站H5播放器能播flv格式？

问：
各个视频格式的兼容性问题？
直播的流采用什么协议，在多媒体的文件中算是哪种格式？
兼容性不好，在播放终端的时候怎么做处理？

> 直播协议
HLS协议  -- hls格式
RTMP协议 -- flv格式
HTTP-FLV协议 -- flv格式

> 对于播放器分点播和直播：
点播：优酷去看个电视剧电影等（mp4、webm）
直播：B站 斗鱼（hls、flv）

HLS协议：直播不像点播一样，一下子给你个视频地址，他也是用video来播，video解析M3U8索引文件，解析出很多片段，每个片段就是一个直播流的分段。直播是实时的，M3U8文件肯定不是固定的，那后面的直播流片段，M3U8文件是怎么知道的？
video在最初会在服务器哪里拿到一个M3U8文件，这个文件解析的直播流片段比如说有9s，其实在9s之前，浏览器也就是video会重新请求M3U8文件。这是浏览器自己的行为。此时服务器会返回新的M3U8文件

### 2-2 直播原理-HLS-2
> HLS协议的工作原理：
Master PlayLists解析出来的是M3U8文件叫Media Playlists
Media Playlists解析出来的文件是ts视频文件

如果M3U8文件解析出来的还是M3U8文件，有的浏览器不支持他是无法播放的。出现这种情况要知道怎么排查

> M3U8文件细分：
动态列表live playlist：直播，就是M3U8文件一直在不断更新变化。M3U8文件就是个纯文本文件
静态列表event playlist：几乎见不到，没人用
全量列表 vod playlist： 点播，就是M3U8文件不再变化

问：我怎么知道这个列表是变化的还是不是变化的？
图2-1动态列表：播放的时候播放器要去查看支持的HLS的版本是多少，如果不支持的话，后边的字段指令可能会解析不出来 #EXT-X-VERSION：6版本是6，默认是3

HLS既可以直播也可以点播，例如直播大阅兵，直播完了再去看就是整理好的点播文件。

> ts文件是什么？
ts文件解析出来先找到PAT包，根据他再找到PMT包，再解析ts包，PMT包会告诉你哪些ts包是音频帧，哪些是视频帧。再把连续的ts包组成一个帧，再相连再组成一个帧。我怎么知道哪些ts包组成一个帧呢？这就需要ts解析规范了。ts中有一个header，他会告诉你这些信息。很多个ts再组成PES

### 2-3 直播原理-RTMP-FLV
视频音频的采集以pc端为主，pc端不是通过web的方式来做而是通过客户端的方式来做,这时基本上要走RTMP协议（视频主播的一般是这种，效率高）;通过web端做,比如是用js h5来做,协议叫web-rtc,这是2种不同的技术方案。

* RTMP方式使用的TCP协议，有3次应答的。在用户端的程序端需要考虑一些问题。一般不使用这种。
* HLS使用的HTTP的，不存在TCP的3次应答。不需要考虑什么。但是有延时，M3U8文件里面有5个ts每个ts是2s，那就是10s，延时大小和切片有关也就是M3U8文件里有几个ts文件
* HTTP-FLV是RTMP-FLV的升级版，flv的长连接，低延时，通信过程并不复杂
* HTTP-FLV优势：
 1. 可以在一定程度上避免防火墙的干扰
 2. 可以很好的兼容HTTP 302跳转，做到灵活调度
 3. 可以使用HTTPS做加密通道
 4. 很好的支持移动端（Android，IOS）
### 2-4 直播原理总结
1. 了解直播协议的分类
2. 理解对应协议的通信原理
3. 理解直播协议之间的区别
 hls好用但是延时，RTMP实时性好，但是实现比较复杂，HTTP-FLV权衡了两种优点，但是视频格式是FLV
4. 掌握不同场景采用什么协议
  采集是利用客户端来做的，通常使用RTMP协议因为后端对TCP通信比较了解；低延时场景使用HTTP-FLV或RTMP；对延时要求不高，比如斗鱼直播，熊猫TV直播，使用HLS协议，因为他传输的是ts文件而不是flv，也不需要建立一个长连接，考虑到服务器的并发等等